<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>两步验证(2-step verification)  &middot; X blog</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="两步验证是一种附加安全功能，旨在防止任何人访问或使用您的帐户，即使他们知道密码也是如此。借助两步验证，您可以通过密码和手机为帐户提供双重保护。" />

<meta name="keywords" content="authentication, 2-factor, 2-step, 2step, verification, ">


<meta property="og:title" content="两步验证(2-step verification)  &middot; X blog ">
<meta property="og:site_name" content="X blog"/>
<meta property="og:url" content="http://dmdgeeker.com/post/two-factor-verification/" />
<meta property="og:locale" content="zh-CN">


<meta property="og:type" content="article" />
<meta property="og:description" content="两步验证是一种附加安全功能，旨在防止任何人访问或使用您的帐户，即使他们知道密码也是如此。借助两步验证，您可以通过密码和手机为帐户提供双重保护。"/>
<meta property="og:article:published_time" content="2016-08-28T14:36:06&#43;08:00" />
<meta property="og:article:modified_time" content="2016-08-28T14:36:06&#43;08:00" />

  
    
<meta property="og:article:tag" content="authentication">
    
<meta property="og:article:tag" content="2-factor">
    
<meta property="og:article:tag" content="2-step">
    
<meta property="og:article:tag" content="2step">
    
<meta property="og:article:tag" content="verification">
    
  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@" />
<meta name="twitter:title" content="两步验证(2-step verification)" />
<meta name="twitter:description" content="两步验证是一种附加安全功能，旨在防止任何人访问或使用您的帐户，即使他们知道密码也是如此。借助两步验证，您可以通过密码和手机为帐户提供双重保护。" />
<meta name="twitter:url" content="http://dmdgeeker.com/post/two-factor-verification/" />
<meta name="twitter:domain" content="http://dmdgeeker.com/">
  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "两步验证(2-step verification)",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/+?rel=author"
    },
    "datePublished": "2016-08-28",
    "description": "两步验证是一种附加安全功能，旨在防止任何人访问或使用您的帐户，即使他们知道密码也是如此。借助两步验证，您可以通过密码和手机为帐户提供双重保护。",
    "wordCount": 171
  }
</script>



<link rel="canonical" href="http://dmdgeeker.com/post/two-factor-verification/" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://dmdgeeker.com/touch-icon-144-precomposed.png">
<link href="http://dmdgeeker.com/favicon.png" rel="icon">

<meta name="generator" content="Hugo 0.26" />

  
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link href='https://fonts.googleapis.com/css?family=Merriweather:300%7CRaleway%7COpen+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="http://dmdgeeker.com/css/font-awesome.min.css">
<link rel="stylesheet" href="http://dmdgeeker.com/css/style.css">
<link rel="stylesheet" href="http://dmdgeeker.com/css/highlight/default.css">

  
  
	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-48344744-1', 'auto');
	  ga('send', 'pageview');

	</script>

</head>
<body>
  <main id="main-wrapper" class="container main_wrapper has-sidebar">
    <header id="main-header" class="container main_header">
  <div class="container brand">
  <div class="container title h1-like">
  <a class="baselink" href="http://dmdgeeker.com/">
  X blog

</a>

</div>

  
<div class="container topline">
  
  TBD


</div>


</div>

  <nav class="container nav primary no-print">
  

<a class="homelink" href="http://dmdgeeker.com/">主页</a>


  
<a href="http://dmdgeeker.com/post" title="所有文章">文章</a>

<a href="http://dmdgeeker.com/tags" title="所有标签">标签</a>


</nav>

<div class="container nav secondary no-print">
  
<a id="contact-link-email" class="contact_link" href="mailto:xheavey@gmail.com">
  <span class="fa fa-envelope-square"></span><span>email</span></a>



<a id="contact-link-github" class="contact_link" href="https://github.com/xionglun">
  <span class="fa fa-github-square"></span><span>github</span></a>























</div>


  

</header>


<article id="main-content" class="container main_content single">
  <header class="container hat">
  <h1>两步验证(2-step verification)
</h1>

  <div class="metas">
<time datetime="2016-08-28">28 Aug, 2016</time>


  
  &middot; Read in about 1 min
  &middot; (171 Words)
  <br>
  
<a class="label" href="http://dmdgeeker.com/tags/auth">auth</a>

<a class="label" href="http://dmdgeeker.com/tags/work">work</a>



</div>

</header>

  <div class="container content">
  

<h3 id="关于两步验证">关于两步验证</h3>

<p>两步验证是一种安全措施，用于保护某些资源不被泄露，即使在泄露了密码的情况下。
两步验证有多种方式，主要包括：短信、验证器、电话等方式。本文主要讲述验证器方式的两步验证。</p>

<h3 id="工作原理">工作原理</h3>

<p>使用基于验证器方式的两步验证通常需要另外一部设备（通常是手机，也可能是其它硬件）。
用户在登录系统时，除了输入正常的密码外，还需要输入一个动态生成的密码。
此动态密码由另外一部可信设备提供，具有一个较短的时效性，保证不会重回攻击。</p>

<p>动态密码生成通常有两种算法：TOTP与HOTP。</p>

<p>TOTP(Time-Based One-Time Password)是指基于时间的一次性密码。<br />
HOTP(HMAC-based One-time Password)是指基于计数的一次性密码。</p>

<p>安全令牌硬件（如某些银行的动态密保，游戏账号的密码令牌）通常是基于HOTP方式实现。
其表现为使用专有硬件，为某一特定产品或系统服务。</p>

<p>而当前大多数两步验证使用的是TOTP方式实现，比如Google Authenticator。</p>

<h3 id="totp流程">TOTP流程</h3>

<p>基于TOTP的两步验证流程一般通过需要先绑定，然后随用随验证。</p>

<p>现假设有一系统<code>S</code>，用户<code>A</code>进行两步验证</p>

<p>绑定流程一般如下：</p>

<ol>
<li>用户<code>A</code>注册/登录系统<code>S</code>后，<code>S</code>后台生成一个OTP链接，在前端生成并显示该链接的二维码<br /></li>
<li>用户<code>A</code>用手机通过Google Authenticator之类的验证器<code>G</code>扫描二维码进行绑定</li>
<li>验证器<code>G</code>会生成动态密码<code>C</code>，用户<code>A</code>将动态密码<code>C</code>输入到系统<code>S</code>的绑定验证框内</li>
<li>如果系统<code>S</code>后台验证该动态密码<code>C</code>成功，则系统<code>S</code>与验证器<code>G</code>绑定成功。否则，绑定失败。</li>
</ol>

<p><img src="/images/2step-verification-bind.png" alt="示意图" /></p>

<p>验证流程如下:</p>

<ol>
<li>用户<code>A</code>通过账号密码登录系统<code>S</code></li>
<li>系统<code>S</code>验证账号和密码匹配后，跳转到两步验证页面</li>
<li>用户<code>A</code>将验证器<code>G</code>里的动态验证码<code>C</code>输入到两步验证页面的验证框中</li>
<li>系统<code>S</code>对验证码<code>C</code>进行验证，如果成功，如登录成功，否则失败</li>
</ol>

<h3 id="totp实现">TOTP实现</h3>

<p>可以按照上面所述流程，一步步来进行实现。
下面主要介绍几个关键部份。</p>

<h4 id="otp链接">OTP链接</h4>

<p>OTP链接格式: <code>otpauth://TYPE/LABEL?PARAMETERS</code>。
具体可参考<a href="https://github.com/google/google-authenticator/wiki/Key-Uri-Format">Google Authenticator URI</a></p>

<p>示例：<code>otpauth://totp/Google:alice@google.com?secret=JBSWY3DPEHPK3PXP&amp;issuer=Google</code></p>

<p>其中，前面一段<code>otpauth://totp/Example:alice@google.com</code>中各部份的意义如下：</p>

<ol>
<li><code>otpauth</code>表示OTP认证协议</li>
<li><code>totp</code>表示使用TOTP算法</li>
<li><code>Google</code>表示生成此链接的公司或软件名称</li>
<li><code>alice@google.com</code>表示该链接所对应的用户的用户名</li>
</ol>

<p>而后面一段查询参数中各部份意义如下：</p>

<ol>
<li><code>secret</code>是由服务端<strong>Base32</strong>编码生成的字符串。其内容不重要，只要保证随机性即可，应保证每个用户都拥有一个独立的<code>secret</code>。</li>
<li><code>issuer</code>表示生成此链接的公司或软件名称，应与前一段中相应部份一致。</li>
</ol>

<h4 id="动态验证码生成">动态验证码生成</h4>

<p>动态验证码的生成算法是公开的，可以到此处进行查处：<a href="https://tools.ietf.org/html/rfc6238">RFC6238</a></p>

<p>下面给出Go语言版本示例:</p>

<pre><code class="language-go">// 6位数字动态验证码
var digits = 6

// secret 即为otpauth链接中的secret
// timeValue 为当前unix时间除以验证码失效时间（通常为30s）
func computeCode(secret string, timeValue int64) string {
	key, err := base32.StdEncoding.DecodeString(secret)
	if err != nil {
		return &quot;&quot;
	}

	hash := hmac.New(sha1.New, key)
	err = binary.Write(hash, binary.BigEndian, timeValue)
	if err != nil {
		return &quot;&quot;
	}
	h := hash.Sum(nil)

	offset := h[len(h)-1] &amp; 0x0f
	val := ((int(h[offset]) &amp; 0x7f) &lt;&lt; 24) |
         ((int(h[offset+1] &amp; 0xff)) &lt;&lt; 16) |
         ((int(h[offset+2] &amp; 0xff)) &lt;&lt; 8) |
         (int(h[offset+3]) &amp; 0xff)
	otp := int64(val) % int64(math.Pow10(digits))
	code := fmt.Sprintf(fmt.Sprintf(&quot;%%0%dd&quot;, digits), otp)
	return code
}
</code></pre>

<h3 id="两步验证的优缺点">两步验证的优缺点</h3>

<p>两步验证的优点：</p>

<ul>
<li>系统的安全性提高，即使其它网站泄露了用户的明文密码，仍可以保证用户账户不受攻击。</li>
<li>动态按时间生成验证码，防止重放攻击。</li>
</ul>

<p>两步验证的缺点：</p>

<ul>
<li>复杂度提高。用户不仅需要输入密码，还需要输入动态验证码。</li>
<li>需要另一个可信设备。即默认用户在绑定时候所使用的设备是安全的。</li>
<li>当验证器不可用时（设备丢失或不在身边），无法登录。</li>
<li>适合web端登录，不适合移动应用登录</li>
</ul>

<h3 id="其它验证方式">其它验证方式</h3>

<p>一、短信认证<br />
短信验证码方式可能是当前中国各大厂商用得最多的一种验证方式。
在用户绑定某个手机号后，将用户与此手机号关联。在有需要进行二次验证的地方，
发送二次验证码短信，用户接收短信并输入该验证码。</p>

<p>二、扫码认证<br />
这在微信登录桌面端与web端的唯一方式。
如果你在桌面web端使用支付宝，通常也可以通过手机支付宝扫页面上二维码进行支付确认。</p>

<p>三、推送认证<br />
当微信桌面端已登录过，保存有信息时，通常会推送一条登录请求给手机微信端，需要在手机端确认。</p>

<h3 id="引用">引用</h3>

<ol>
<li><a href="https://www.google.com/landing/2step/">Google 两步验证</a></li>
<li><a href="https://support.apple.com/zh-cn/HT204152">Apple 两步验证</a></li>
<li><a href="https://support.apple.com/zh-cn/HT204915">Apple 双重认证</a></li>
</ol>

</div>


  <footer class="container">
  <div class="container navigation no-print">
  <h2>Navigation</h2>
  
  

    
    <a class="prev" href="http://dmdgeeker.com/post/authority-merit/" title="Authority &amp; Merit">
      Previous
    </a>
    

    
    <a class="next" href="http://dmdgeeker.com/post/markdown-syntax/" title="Markdown 语法">
      Next
    </a>
    

  


</div>

  <div class="container comments">
  <h2>Comments</h2>
  
<div id="disqus_thread"></div>
<script type="text/javascript">
  (function() {
    
    
    if (window.location.hostname == "localhost")
      return;

    var dsq = document.createElement('script'); dsq.async = true; dsq.type = 'text/javascript';
    dsq.src = '//dmdgeeker.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


</div>

</footer>

</article>
      <footer id="main-footer" class="container main_footer">
  

  <div class="container nav foot no-print">
  

  <a class="toplink" href="#">back to top</a>

</div>

  <div class="container credits">
  
<div class="container footline">
  
  本站文章除注明转载外，均为本站原创或编译。未经本人书面允许，不得擅自转载。


</div>


  
<div class="container copyright">
  
  &copy; 2016-2017 Allen Heavey.


</div>


</div>

</footer>

    </main>
    
<script type="text/javascript">
  (function() {
    
    
    if (window.location.hostname == "localhost")
      return;

    var dsq = document.createElement('script'); dsq.async = true; dsq.type = 'text/javascript';
    dsq.src = '//dmdgeeker.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>



<script src="http://dmdgeeker.com/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


    
  </body>
</html>

